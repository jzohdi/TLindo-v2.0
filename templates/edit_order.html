{% extends "layout.html" %} {% block title %} Edit Order {% endblock %} {% block
head %}
<script>
  Flask.url_for("edit_order");
</script>

{% endblock %} {% block main %}
<div id="modalHolder"></div>
<div id="main-planner-page" class="container">
  <div id="select-menu" class="row normalize-height">
    <div
      id="card2"
      class="col-md-10 col-md-offset-1 main-card fade-in-left helper-screen"
    >
      <div class="row main-menu-box">
        <h4 id="number-rec"></h4>
        <div class="col-md-6">
          <h3 class="main-menu-headers">Entrees</h3>
          <div class="col-md-8 col-md-offset-2">
            <div id="entree" class="row"></div>
          </div>
        </div>
        <div class="col-md-6">
          <h3 class="main-menu-headers">Sides</h3>
          <div class="col-md-8 col-md-offset-2">
            <div id="side" class="row"></div>
          </div>
        </div>
        <div id="selected-food" class="col-md-8">
          <h3 class="main-menu-headers">
            Your Cart
          </h3>
          <div id="my-cart" class="row"></div>
        </div>
      </div>
      <div style="text-align: center;">
        <h4>New Total: $<span id="cart-total"></span></h4>
      </div>
      <div style="text-align: center;">
        <h4>Already Paid: {{ order.paid }}</h4>
      </div>
      <div
        id="checkoutButton"
        class="button button1 checkout-button col-xs-5 col-sm-3"
      >
        Confirm Changes
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  const ITEM_HTML_FOR_LIST =
    '<div class="col-xs-12 col-sm-10 col-sm-offset-1"><span class="span increase"  id="appendValuePlaceholder"> ' +
    '+ </span> countPlaceholder <span class="span decrease" id="appendValuePlaceholder"> - </span>';
  const DEFAULT_MIN = 8;

  const MAIN_MODAL_CONTENT =
    "<h2> ItemNamePlaceholder: </h2>" +
    "<p> HeaderPlaceholder </p>" +
    "<div class='selection row'> SelectionPlaceholder <div id='addToCart'" +
    "class='col-xs-2 col-xs-offset-8 add-select'>Add to cart</div></div>" +
    '<div class="row modal-add-to-order">namePlaceholder\'s in your cart: </div><div id="idPlaceholder"' +
    ' class="row"></div><div class="button button1" id="done-selection">Done</div>';
  class MenuItem{
    constructor(itemDictionary){
      this.environ = itemDictionary;
      this.notSelectKeys = new Set(["name" , "description", "_id", "type"]);
      this.toLimit = new Set(["Entree", "entree"]);
    }

    button = function(){
      return `<div id="${this.getId()}"
                class="entree-item col-xs-12 col-sm-6 col-md-12 entree-options">
                  ${this.environ.name}
              </div>`;
    }
    getId = function(){
      return this.environ.name.replace(/\s/g,'-').replace("&", "and");
    }
    target = function(){
      return "#" + this.environ.type.toLowerCase();
    }
    getModalContent = function(help){
      let content =  MAIN_MODAL_CONTENT
      .replace("ItemNamePlaceholder", this.environ.name)
      .replace("HeaderPlaceholder", this.getHeader())
      .replace("SelectionPlaceholder", this.getSelection(help))
      .replace("namePlaceholder", this.environ.name)
      .replace("idPlaceholder", "modal-cart")
      return content
    }
    getSelection = function(help){
      let content = ""
      for (const key in this.environ ) {
        if ( this.notSelectKeys.has(key) ){
          continue;
        }
        if (
          this.environ.hasOwnProperty(key) &&
          this.environ[key].length > 1
        ) {
          content += this.getSelectDiv(key, this.environ[key], help);
          }
        }
      return content;
    }

    getSelectDiv = function(key, array, help) {
      if ( !typeof(array) ){
        return "";
      }
      key = this.trimKey(key);
      let content = `<div class='col-sm-6 col-md-4'> Choose ${key} :  <select class='select-setting'>`
      // if asking for help, and the item is of entree type, and the key is the size. only return option for the smallest size
      if ( help && this.toLimit.has(this.environ.type) && key == 'size'){
        const sizeKey = ( this.environ.hasOwnProperty("sizes") ) ? 'sizes' : 'size';
        const currentLargestSize = Math.min.apply(Math, this.environ[sizeKey].map(function(object) { return object.Count; }))
        const value = this.environ[sizeKey].find( function(object) { return object.Count == currentLargestSize })
        return content + `<option value='${key}'>${value.name.trim()}</option></select></div>`;
      }
      $.each(array, function(index, value) {
        if ( typeof(value) == 'object' && value.hasOwnProperty('name') ){
          value = value.name;
        }
        content += `<option value='${key}'>${value.trim()}</option>`;
      });
      content += "</select></div>";
      return content;
    }
    trimKey = function(key) {
      if (key.slice(-1) == "s") {
        key = key.slice(0, -1);
      }
      return key;
    }

    getHeader = function(){
      let description = "<ul>";
      if( this.environ.hasOwnProperty("description") ){
        if ( this.environ.description.length > 0 ){
          $.each(this.environ.description, function(index, element) {
            description += `<li>${element}</li>`;
          })
        }
      }
      return description + '</ul><p class="please-select-from">Please choose from options:</p>';

    }
  }

  class FoodCounter{
    constructor(cart, app, pricesDict){
      this.cart = cart.map(function(itemObject){ delete itemObject.cost; return itemObject });
      this.toLimit = new Set(["Entree", "entree"]);
      this.parentApp = app;
      this.possibleSizeKeys = ['size', 'sizes', 'portion', 'portions'];
      this.possibleCostKeys = [...this.possibleSizeKeys, "flavor", "flavors", "meat", "protein"]
      this.prices = pricesDict;
    }

    addItemToCart = function(itemToAdd){
      for ( const itemInCart of this.cart ){
        // if item is the same as another item except for the count, append 1 to the count.
          if ( objectsAreEqual(itemInCart, itemToAdd, ['count'])){
            itemInCart.count = itemInCart.count + 1;
            return;
          }
      }
      this.cart.push(itemToAdd);
    }

    getHtmlForItem = function( itemObject, index ) {
        const appendValueParams = index.toString();
        let newDiv = ITEM_HTML_FOR_LIST.replace(/appendValuePlaceholder/g, appendValueParams)
        .replace("countPlaceholder", itemObject.count);

      for (const key in itemObject) {
        if (key != "count") {
          newDiv += `<span class="my-cart-key"> ${itemObject[key]}</span><strong class="order-keys"> | </strong>`;
        }
      }
      return newDiv;
    }

    toString = function(itemName = null){
      let total = 0.00;
      let cartToString = "";
      const self = this;
      this.cart.forEach( function(itemInCart, index) {
        if ( !itemName || itemInCart.name == itemName ){
          cartToString += self.getHtmlForItem(itemInCart, index);
          const itemPrice = self.getPriceForItem(itemInCart).toFixed(2);;
          cartToString +=  `<small class="my-cart-key">$${itemPrice}</small></div>`;
          total += parseFloat(itemPrice);
        }
      })
      $('#cart-total').html(total.toFixed(2));
      return cartToString;
    }

    canAddItemToCart = function(selectionItemObject, maxFlavors, maxItems, type, help){

      maxFlavors = Math.min(maxFlavors, maxItems);
      if ( this.alreadyAtMaxFlavorLimit(selectionItemObject, maxFlavors) ){
        return false;
      }
      return true;
    }

    getAddToCartError = function(selectionItemObject, maxFlavors, maxItems){
      maxFlavors = Math.min(maxFlavors, maxItems);
      if ( this.alreadyAtMaxFlavorLimit(selectionItemObject, maxFlavors) ){
        return AT_FLAVOR_LIMIT_DIV;
      }
      return "";

    }

    alreadyAtMaxFlavorLimit = function(itemObj, appMaxFlavors){
      const countedFlavors = new Set([itemObj.flavor]);
      let flavorCount = 1
      for ( const itemInCart of this.cart ){
        if ( !itemInCart.hasOwnProperty("flavor") || countedFlavors.has(itemInCart.flavor)){
          continue;
        }
        if ( itemInCart.name === itemObj.name ){
          if ( flavorCount == appMaxFlavors ){
            return true;
          }
          countedFlavors.add(itemInCart.flavor);
          flavorCount = flavorCount + 1;
        }
      }
      return false;
    }
    getPriceForItem = function(itemToGetPricesFrom){
      let total = 1.00;
      const itemName = itemToGetPricesFrom.name;
      const keysToCalculateCost = this.getCostKeys(itemToGetPricesFrom);

      const thisItemPriceDict = this.prices[ itemName ];
      for ( const key of keysToCalculateCost ){
        const priceDictKeyValue = parseFloat( thisItemPriceDict[key] )
        total *= priceDictKeyValue.toFixed(2);
      }
      total *= itemToGetPricesFrom['count'].toFixed(2);
      return total

    }

    getCostKeys = function(itemObject){
      const keysFoundInItemObject = [];
      for ( const possibleCostKey of this.possibleCostKeys ){
        if ( itemObject.hasOwnProperty(possibleCostKey) ){
          keysFoundInItemObject.push(itemObject[possibleCostKey]);
        }
      }
      return keysFoundInItemObject;
    }

  }

  class App{
    constructor(cart, menu, pricesDict){
      this.menu = {}
      for ( const menuItem of menu ){
        this.menu[menuItem.name] = new MenuItem(menuItem);
      }
      this.toLimit = new Set(["Entree", "entree"]);
      this.foodCounter = new FoodCounter(cart['order'], this, pricesDict);
      this.maxItems = 20;
      this.maxFlavors = 4;
      this.currentItem = ''
      this.help = false;
      this.validGuests = false;
      this.environ = {}
    }

    run = function(){
      if ( this.foodCounter.cart.length > 0 ){
        this.showSelectedFood('#my-cart');
      }
      for ( const menuItem in this.menu ){
        const menuClass = this.menu[menuItem]
        $(menuClass.target()).append(menuClass.button());

        const MyApp = this;

        $("#" + menuClass.getId() ).on('click', function(){

          const itemName = menuClass.environ.name;
          MyApp.currentItem = itemName;
          const type = MyApp.menu[itemName].environ.type;
          // create modal
          createModal('#modalHolder', menuClass.getModalContent(MyApp.help) );
          // show current items of this in cart to modal
          MyApp.showSelectedFood('#modal-cart', itemName);

          MyApp.attachAddToCartControlls(itemName, type);

          const close = document.getElementsByClassName('close')[0];

          close.addEventListener('click', function(){
            MyApp.currentItem = '';
            MyApp.showSelectedFood('#my-cart')
          });
        });
      }
    }

    showSelectedFood = function(idOfTarget, itemName = undefined, errorMessage = ""){
      const MyApp = this;

      let cartToString = this.foodCounter.toString(itemName);
      $(idOfTarget).html(cartToString);

      // add controllers for the increase count and decrease count
      const incButtons = document.getElementsByClassName("increase");
      for ( let x = 0; x < incButtons.length; x++ ){
        incButtons[x].addEventListener("click", function(){
          MyApp.foodCounter.cart[this.id].count += 1;
          MyApp.showSelectedFood(idOfTarget, itemName);
        })
      }

      const decButtons = document.getElementsByClassName("decrease");
      for ( let x = 0; x < decButtons.length; x++ ){
        decButtons[x].addEventListener("click", function(){
          MyApp.foodCounter.cart[this.id].count -= 1;
          // if the count for this item goes to 0, remove it from the cart.
          if ( MyApp.foodCounter.cart[this.id].count == 0 ){
            MyApp.foodCounter.cart.splice(this.id, 1);
          }
          MyApp.showSelectedFood(idOfTarget, itemName);
        })
      }
    }

    attachAddToCartControlls = function(itemName, type){
      const MyApp = this;
      $("#addToCart").on('click', function(){
        // create item object.
        const selectionItemObject = getSelectedOptions(itemName, type)
        // if can add it to cart
        if ( MyApp.foodCounter.canAddItemToCart(selectionItemObject, MyApp.maxFlavors, MyApp.maxItems, type, MyApp.help) ){
          // add the item to the card and re draw selection.
          MyApp.foodCounter.addItemToCart(selectionItemObject);
          MyApp.showSelectedFood('#modal-cart', itemName)
        }else{
          const errorMessage = MyApp.foodCounter.getAddToCartError(selectionItemObject, MyApp.maxFlavors, MyApp.maxItems);
          MyApp.showSelectedFood('#modal-cart', itemName, errorMessage);
            if ( errorMessage.includes("cart limit") ){
              attachAddMore();
            }
        }
      });
    }

  }

  const getSelectedOptions = function(nameOfItem, itemType){
    const $selected = $(".select-setting");
    const thisItem = { count: 1, name: nameOfItem, type: itemType };
    $.each($selected, function(index, value) {
      thisItem[
        $(value)
          .find("option:selected")
          .val()
          .trim()
      ] = $(value)
        .find("option:selected")
        .text()
        .trim();
    });
    return thisItem;
  }
  let app = null;

  const getPricesAsync = function(){
    const response = fetch("/get_prices/").then(function(response) {
      return response.json();
    }).then(function(myJson) {
        app = new App( {{ order | tojson }}, {{ menu | tojson }}, myJson);
        app.run();
        main(); }).catch( (error)=> {
        location.reload()
       });
  }

  getPricesAsync();

  const main = () => {
    $('#checkoutButton').on('click', function(){
      const form = document.createElement("form");
      const hiddenInput = document.createElement("input");
      hiddenInput.setAttribute("type", "hidden");
      hiddenInput.setAttribute("name", "order");
      hiddenInput.setAttribute("value", JSON.stringify(app.foodCounter.cart));
      form.appendChild(hiddenInput)
      $.post('/commit_order_edit/', $(form).serialize() )
      .done( data => { if ( data.hasOwnProperty('error')){
        alert("Something went wrong.")
      }else{
        location.href = "/user_orders";
      } } ) ;
  });
  }
</script>
{% endblock %}
